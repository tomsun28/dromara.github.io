<!doctype html><html><head><title>One year later, the dromara team released version 2.1.1 of the new architecture Hmily distributed transaction framework · dromara(Open source organization)</title><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="The girl on the prairie"><meta name=wwads-cn-verify content=8d5e957f297893487bd98fa830fa6413><meta name=generator content="Hugo 0.55.5"><link rel="shortcut icon" href=/img/favicon.png type=image/png><link href=https://unpkg.com/purecss@1.0.0/build/base-min.css rel=stylesheet><link href=/css/main.css rel=stylesheet><link href=/css/zoom-image.css rel=stylesheet><script src=/js/iconfont.js></script><script src=/js/highlight.pack.js></script><script>hljs.initHighlightingOnLoad();</script><script>window.SITE_LANGUAGE="en"</script><script src=/js/app.js></script><script>var _hmt=_hmt||[];(function(){var hm=document.createElement("script");hm.src="https://hm.baidu.com/hm.js?a02cb5c75097762223d5a815a03e0a15";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm,s);})();</script><script type=text/javascript src=https://cdn.wwads.cn/js/makemoney.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-187960192-2','auto');ga('send','pageview');}</script></head><body><header class=ss-header><nav class=navbar role=navigation aria-label="main navigation"><div class=navbar-brand><a class=logo-link href=/><img class=logo src=/img/logo/dromara.jpg></a><div class=-show-mobile><a id=mobile-menu-icon><svg class="icon" aria-hidden="true"><use xlink:href="#icon-menu"/></svg></a><nav id=mobile-menu><div id=js-menu-search-mobile class=navbar-search-mobile><input class=input placeholder=Search><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search"/></svg></div><a href=/projects/><span>Projects</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/blog/><span>Blog</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/activities/><span>Activity</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/community/><span>Community</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/awesome/><span>Awesome Dromara</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/zh/community/hmily-2.1.1/><span>中文</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-transfer"/></svg></a></nav></div></div><div class="navbar-menu -hidden-mobile"><div class=navbar-start><a class=navbar-item href=/projects/>Projects</a>
<a class=navbar-item href=/blog/>Blog</a>
<a class=navbar-item href=/activities/>Activity</a>
<a class=navbar-item href=/community/>Community</a>
<a class=navbar-item href=/awesome/>Awesome Dromara</a></div><div class=navbar-end><div class=navbar-item><div id=js-menu-search class=navbar-search><input class=input placeholder=Search><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search"/></svg></div></div><div class=navbar-item><a class=translation href=/zh/community/hmily-2.1.1/>中</a></div></div></div></nav></header><div class=ss-layout-container><main class="ss-layout-main -card"><div class=ss-meta><h1 class=title>One year later, the dromara team released version 2.1.1 of the new architecture Hmily distributed transaction framework</h1><div class=meta>2020-09-28 ·
xiaoyu ·
<span class=tags><a class=tag href=/tags/hmily/ rel=tag>#hmily</a></span></div></div><article class=typo><p>Thank you guys for your support all the way, and keep everyone waiting. In this version, our team refactored the entire project, reasonably divided functional modules, added configuration centers, adjusted the underlying storage structure, solved difficult bugs, and supported other new features, and absorbed more outstanding open source community members to join in.</p><h2 id=architecture>Architecture</h2><p><img src=../../img/architecture/hmily-framework.png alt=架构全景图></p><h3 id=features>Features</h3><ul><li>High availability·: Supports abnormal transaction rollback and overtime transaction recovery in distributed scenarios to prevent transaction suspension.</li><li>Ease of use: Provide zero-invasive Spring-Boot, Spring-Namespace to quickly integrate with business systems.</li><li>High performance: Decentralized design, fully integrated with business systems, naturally supports cluster deployment.</li><li>Observability: Performance monitoring of multiple metrics by Metrics, as well as admin management UI .</li><li>Multiple RPCs: support Dubbo, SpringCloud, Motan, Sofa-rpc and other well-known RPC frameworks.</li><li>Log storage: Support Mysql, Oracle, Mongodb, Redis, Zookeeper, etc.</li><li>Complex scenarios: Support RPC nested call transactions.</li></ul><h3 id=refactoring-part>Refactoring part</h3><ul><li><p><strong>Module division:</strong></p><ul><li><p>Extract the SPI custom module and It&rsquo;s open-the-box.</p></li><li><p>SPI module that defines multiple storage methods for transaction logs.</p></li><li><p>SPI module that defines multiple serialization methods for transaction logs.</p></li><li><p>Add configuration center, support various mainstream configuration centers (Nacos, Apollo, Zookeeper, etc.), and support dynamic refresh of configuration.</p></li><li><p>Add metrics module to monitor various information at runtime.</p></li><li><p>Remove the core transaction execution module.</p></li><li><p>Extract multiple RPC support modules.</p></li><li><p>Extract the Spring and Spring Boot support modules.</p></li></ul></li><li><p><strong>On the dependent package version:</strong></p><ul><li>Guava upgraded to 2.9.0.</li><li>Curator upgraded to 5.1.0.<br></li></ul></li><li><p><strong>Code quality:</strong></p><ul><li>Strict check-style code inspection, adhering to the principle of elegance and simplicity (talk is cheap, show you code).<br></li></ul></li><li><p><strong>openness :</strong></p><ul><li>The community pursues the basic principles of simplicity, happiness, and harmony.<br></li></ul></li><li><p><strong>Goal:</strong></p><ul><li>Create a high-availability, high-performance, easy-to-use financial-level distributed transaction solution.</li></ul></li></ul><h3 id=solve-bugs>Solve bugs:</h3><ul><li>The Dubbo framework does not support the use of annotations (spring-boot-starter-dubbo).</li><li>The Motan framework does not support the use of annotations.</li><li>If Spring Cloud users use Feign and Hystrix to integrate Hmily, the thread switching problem occurs.</li><li>In extreme cases, the transaction log serialization is abnormal.</li><li>If timeout happen in <code>try</code>, It will cause the transaction suspension bug.</li><li>When the <code>confirm</code> and <code>cancel</code> phases are abnormal, the transaction fails to rollback.</li><li>In the transaction log storage, two modes of synchronous and asynchronous are supported for users to choose.</li></ul><h3 id=user-guide>User guide</h3><p>For Hmily users, it only takes three steps to achieve the BASE transaction between RPC service calls</p><ul><li>Add the maven dependencies supported by Hmily for various RPC.</li><li>Add Hmily configuration.</li><li>Add <code>@Hmily</code> annotation to RPC interface method.</li></ul><h4 id=dependency-changes>Dependency changes</h4><p>There is no change to the dependencies, only the version needs to be upgraded to 2.1.0. Here are examples of Dubbo microservices.</p><h4 id=dubbo-rpc-microservices>Dubbo RPC microservices</h4><ul><li>Dubbo interface service dependency.</li></ul><pre><code class=language-xml>     &lt;dependency&gt;
          &lt;groupId&gt;org.dromara&lt;/groupId&gt;
          &lt;artifactId&gt;hmily-annotation&lt;/artifactId&gt;
          &lt;version&gt;2.1.0&lt;/version&gt;
      &lt;/dependency&gt;
</code></pre><ul><li>Dubbo service provider depends on version&lt;2.7.</li></ul><pre><code class=language-xml>       &lt;dependency&gt;
            &lt;groupId&gt;org.dromara&lt;/groupId&gt;
            &lt;artifactId&gt;hmily-dubbo&lt;/artifactId&gt;
           &lt;version&gt;2.1.0&lt;/version&gt;
        &lt;/dependency&gt;

    or 

      &lt;dependency&gt;
            &lt;groupId&gt;org.dromara&lt;/groupId&gt;
            &lt;artifactId&gt;hmily-spring-boot-starter-dubbo&lt;/artifactId&gt;
           &lt;version&gt;2.1.0&lt;/version&gt;
        &lt;/dependency&gt;
</code></pre><h4 id=hmily-configuration-changes>Hmily configuration changes</h4><p>In the new version 2.1.0, the hmily-config module has been added to support local and registry modes. The user first needs to create a new file named <code>hmily.yml</code> under the project <code>resouce</code> file. The default path is the project&rsquo;s <code>resource</code> directory, it can also be specified with <code>-Dhmily.conf</code>, or the configuration can be placed in the <code>user.dir</code> directory. Priority level <code>-Dhmily.conf</code>&gt; <code>user.dir</code>&gt; <code>resource</code>. The file format is as follows (The local mode of configuration):</p><pre><code class=language-yml>  server:
    configMode: local
    appName: account-dubbo
  config:
    appName: account-dubbo
    serializer: kryo
    contextTransmittalMode: threadLocal
    scheduledThreadMax: 16
    scheduledRecoveryDelay: 60
    scheduledCleanDelay: 60
    scheduledPhyDeletedDelay: 600
    scheduledInitDelay: 30
    recoverDelayTime: 60
    cleanDelayTime: 180
    limit: 200
    retryMax: 10
    bufferSize: 8192
    consumerThreads: 16
    asyncRepository: true
    autoSql: true
    phyDeleted: true
    storeDays: 3
    repository: mysql

repository:
  database:
    driverClassName: com.mysql.jdbc.Driver
    url : jdbc:mysql://127.0.0.1:3306/hmily?useUnicode=true&amp;characterEncoding=utf8
    username: root
    password:
    maxActive: 20
    minIdle: 10
    connectionTimeout: 30000
    idleTimeout: 600000
    maxLifetime: 1800000
</code></pre><p><strong>If you want to use Nacos as configuration center:</strong></p><pre><code class=language-yml>hmily:
  server:
    configMode: nacos
    appName: xxxxx
remote:
  nacos:
    server: 192.168.3.22:8848
    dataId: hmily.properties
    group: DEFAULT_GROUP
    timeoutMs: 6000
    fileExtension: yml
    passive: true
</code></pre><p><strong>If you want use Apollo as configuration center：</strong></p><pre><code class=language-yml>hmily:
  server:
    configMode: apollo
    appName: xxxx
remote:
  apollo:
    appId: hmily-xxxxx
    configService: http://192.168.3.22:8080
    namespace: byin_hmily
    secret:
    fileExtension: yml
    passive: true
    env: dev
    meta: http://192.168.3.22:808
</code></pre><p>If you want to know more configuration methods and detailed explanations of configuration content, please refer to: <a href=https://dromara.org/zh-cn/docs/hmily/config.html>https://dromara.org/zh-cn/docs/hmily/config.html</a> .</p><p><strong>Changes in the use of annotation methods</strong></p><p>In the previous version, RPC interface and implementation only need to add <code>@Hmily</code> annotation, but now It need to be changed, you need to add <code>@Hmily</code> in the RPC interface method, which is used to identify this is a Hmily distributed transaction interface method , besides, you need to add <code>@HmilyTCC</code> to the implementation of the interface, and then specify the method names of <code>confirm</code> and <code>cancel</code>.</p><p><strong>Example (say method in Dubbo needs to participate in distributed transactions):</strong></p><pre><code class=language-java>public interface HelloService {

    @Hmily
    void say(String hello);
}

public class HelloServiceImpl implements HelloService  {

    @HmilyTCC(confirmMethod = &quot;sayConfrim&quot;, cancelMethod = &quot;sayCancel&quot;)
    public void say(String hello) {
         System.out.println(&quot;hello world&quot;);
    }

    public void sayConfrim(String hello) {
         System.out.println(&quot; confirm hello world&quot;);
    }

    public void sayCancel(String hello) {
         System.out.println(&quot; cancel hello world&quot;);
    }
}
</code></pre><p><strong>Example (say method in springcloud needs to participate in distributed transactions):</strong></p><ul><li>Spring-cloud service caller FeignClient.</li></ul><pre><code class=language-java>@FeignClient(value = &quot;helle-service&quot;)
public interface HelloService {

    @Hmily
    @RequestMapping(&quot;/helle-service/sayHello&quot;)
    void say(String hello);
}
</code></pre><ul><li>Spring-cloud provider.</li></ul><pre><code class=language-java>@RestController
public class HelloController {

    private final HelloService helloService ;

    @Autowired
    public AccountController(HelloService helloService) {
        this.helloService= helloService;
    }

    @RequestMapping(&quot;/sayHello&quot;)
    public void payment(String hello) {
        return helloService.say(hello);
    }
}
public interface HelloService {

    void say(String hello);
}
public class HelloServiceImpl implements HelloService  {

    @HmilyTCC(confirmMethod = &quot;sayConfrim&quot;, cancelMethod = &quot;sayCancel&quot;)
    public void say(String hello) {
         System.out.println(&quot;hello world&quot;);
    }

    public void sayConfrim(String hello) {
         System.out.println(&quot; confirm hello world&quot;);
    }

    public void sayCancel(String hello) {
         System.out.println(&quot; cancel hello world&quot;);
    }
}
</code></pre><ul><li><strong>Changes in transaction log storage structure</strong></li></ul><p>Users don&rsquo;t need to care about using or upgrading, the framework will be initialized by default.</p><h2 id=next-version>Next version</h2><ul><li>Because of the adjustment of the architecture, it will be easier to support other modes. In the next version, TAC mode (try-auto-cancel) will be released, which will greatly simplify the use of the framework. You need only to care about the development of <code>confirm</code> and <code>cancel</code> methods, and It&rsquo;s provide better compatibility with the transformation of the old system. Don&rsquo;t worry about additional development tasks, just leave everything to Hmily!</li><li>It will support Brpc.</li><li>It will support Tars-rpc.</li></ul><h2 id=community>Community</h2><p>We uphold the principle of harmony and happiness. If you have ideas and want to contribute to community, come and join us!</p><ul><li>Github: <a href=https://github.com/dromara/hmily>https://github.com/dromara/hmily</a></li><li>Gitee: <a href=https://gitee.com/dromara/hmily>https://gitee.com/dromara/hmily</a></li><li>QQ group: 162614487</li></ul></article><div class="wwads-cn wwads-horizontal" data-id=127 style=max-width:500px></div><div class=-show-mobile><nav class=ss-pagination-next><a class=link-prev href=/community/hmily-restart/><span class=text>Prev:</span>
<span class=text>Hmily distributed transaction restart monthly report</span></a></nav></div></main><aside class=ss-layout-aside><div class=ss-card><h2 class=card-title>Related</h2><ul class=ss-aside-related><li><a href=/community/hmily-restart/>Hmily distributed transaction restart monthly report</a></li><li><a href=/community/hmily-2.0.2/>Hmily released 2.0.2-Release</a></li><li><a href=/blog/hmily_current/>Hmily: Easy Handle Highly Concurrent Distributed Transactions</a></li><li><a href=/blog/hmily_introduction/>Hmily: High-Performance Asynchronous Distributed Transaction TCC Framework</a></li></ul></div><div class="ss-aside-tags ss-card"><h2 class=card-title>Tag
<span class=card-extra></span></h2><ul class=tag-list><li class=tag><a href=/tags/dreamcode/>DreamCode</a></li><li class=tag><a href=/tags/dromara/>Dromara</a></li><li class=tag><a href=/tags/gateway/>GateWay</a></li><li class=tag><a href=/tags/hmily/>hmily</a></li><li class=tag><a href=/tags/reactor/>Reactor</a></li><li class=tag><a href=/tags/soul/>Soul</a></li><li class=tag><a href=/tags/tcc/>TCC</a></li></ul></div></aside></div><footer class=ss-footer><div class=container><div class=links><div class=cate><h2 class=cate-title>Resources</h2><a class=link href=https://github.com/dromara>Github</a>
<a class=link href=https://gitee.com/dromara>Gitee</a></div><div class=cate><h2 class=cate-title>Get Involved</h2><a class=link href=https://github.com/dromara/soul/issues/new>Feedback</a>
<a class=link href=/community>Community</a>
<a class=link href=/blog>Blog</a></div><div class=cate><h2 class=cate-title>Document</h2><a class=link href=/projects/hmily/overview/>Hmily</a>
<a class=link href=/projects/raincat/overview/>Raincat</a>
<a class=link href=/projects/myth/overview/>Myth</a></div></div><div class=qrcode><div><img class=qrcode-img src=/img/qrcode/qrcode_1.png><p class=qrcode-desc>Wechat Official Account</p></div><div><img class=qrcode-img src=/img/qrcode/qrcode_2.png><p class=qrcode-desc>QQ Group</p></div><div><img class=qrcode-img src=/img/qrcode/zsxq.png><p class=qrcode-desc>Knowledge Planet</p></div></div></div><div class=copyright><p>Copyright ©2021
<a href=/>@dromara. org. All Rights Reserved</a></p></div></footer></body></html>